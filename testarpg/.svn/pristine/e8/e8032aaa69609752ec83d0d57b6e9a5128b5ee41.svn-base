
module egret {

	export class SceneWindow extends SceneDriver{
		//场景数据
		public _sceneData:SceneData = null;
		//场景元素数据
		public _sceneElementData:SceneElementData = null;
		//元素管理器
		public _sceneElementManager:SceneElementManager = null;
		//当前怪物元素
		private _monsters:Array<ElementMonster> = [];
		//任意一个场景之外的其他场景元素
		private _otherElements:Array<SceneElementDriver> = [];
		//掉落物品元素
		private _goodsList:Array<ElementGoods> = [];
		private _goodsIndex:number;

		/**
		 * 构造函数
		 */
		public constructor(){
			super();

			this._sceneData = dataManager().sceneData;
			this._sceneElementData = dataManager().sceneElementData;
			this._sceneElementManager = SceneElementManager.getInstance();
			
			this._elementRadius = SceneElementData.ARRIVE_ELEMENT_RADIUS;
		}
		
		public initWindow():void{
			super.initWindow();
			
			this.addUpdateType(
				UpdateType.PLAYER_EXIT_SCENE,
				UpdateType.PLAYER_ENTER_SCENE,
				UpdateType.PLAYER_VO_CHANGED,
				UpdateType.NORMAL_COPY_MONSTER_BORN,
				UpdateType.DAMAGE_HP_CHANGE
			);
		}
		
		public initData(data:SceneEditLo):void{
			super.initData(data);
			
			if(this._sceneData.isChanged){
				this._sceneData.isChanged = false;
				
				var sceneLo:SceneLo = LocalData.getInstance().getSceneLo(this._sceneData.cityId);
				var id:number = sceneLo.bornPoint;
				var lo:RoleBornPointLo = LocalData.getInstance().getRoleBornPointLo(id);
				
				if(lo){
					this.gotoXY(lo.point.x,lo.point.y);
				}
			}else{
				//this.gotoXY(this._role.x,this._role.y);
				//测试
				this.gotoXY(605,1580);
				this.nextTurn();
			}
		}
		//
		public nextTurn():void{
			TimerManager.getInstance().addExecute(function():void{
				globalUpdateWindows([UpdateType.NORMAL_COPY_MONSTER_BORN]);
			},null,5000,null,1);
		}
		
		public addEvents():void{
			super.addEvents();
			
			this.addEventListener(SceneEvent.SCENE_ARRIVE_NAVI_POINT,this.sceneArriveNiviPoint,this);
		}
		
		public remove():void{
			super.remove();
			
			this.removeEventListener(SceneEvent.SCENE_ARRIVE_NAVI_POINT,this.sceneArriveNiviPoint,this);
		}
		
		public globalUpdate(updateType:number, ...parameters):void{
			switch(updateType){
				//玩家离开当前场景
				case UpdateType.PLAYER_EXIT_SCENE:
					this.removePlayer(parameters[0]);
					break;
				//玩家进入当前场景
				case UpdateType.PLAYER_ENTER_SCENE:
					this.renderElement(parameters[0]);
					break;
				//玩家场景数据改变
				case UpdateType.PLAYER_VO_CHANGED:

					break;
				//普通副本怪物出生
				case UpdateType.NORMAL_COPY_MONSTER_BORN:
					var roles:Array<SceneElementDataItem> = [Role.getInstance().data];

					var list:Array<SceneElementDataItem> = this._sceneData.getArmies();
					for(var i in list){
						var monster:ElementMonster = this.renderMonster(list[i]);

						if(monster){
							this._monsters[i] = monster;
						}else{
							monster = this._monsters[i];
						}
						monster.chaseArmies(roles);
					}

					this._sceneData.resetRoleData();
					Role.getInstance().updateHp();
					Role.getInstance().chaseArmies(list);
					break;
				//伤害生命变化
				case UpdateType.DAMAGE_HP_CHANGE:
					list = parameters[0];
					var damageValues:Array<DamageDataItem> = parameters[1];
					var radians:Array<number> = parameters[2];
					var container:DisplayObjectContainer = this._isoMap.getLayerContainer(SceneLayerType.TIP_EFFECT);

					for(var i in list){
						var vo:SceneDriverVo = <SceneDriverVo>list[i].vo;
						var driver:SceneElementDriver = <SceneElementDriver>this.getElement(vo.idString);
						if(driver){
							driver.updateHp();

							if(damageValues[i].isCritical){
								var color:number = 0xff0000;
								var size:number = 20;
								var value:string = "暴" + damageValues[i].value;
							}else{
								color = 0xffff00;
								size = 16;
								value = damageValues[i].value + "";
							}

							HPTweenManager.getInstance().tween(container,vo.x,vo.y - 50,radians[i],200,value,color,size);

							if(vo.hp <= 0){
								this.removeElement(driver);

								if(!this._sceneData.checkArmy()){
									this.showGoods(vo.x,vo.y);

									this.nextTurn();
								}
							}
						}
					}
					break;
			}
		}
		//物品掉落
		private showGoods(x:number,y:number):void{
			this._goodsList.length = 0;

			var goodsList:Array<SceneElementDataItem> = this._sceneData.getGoodsList(x,y);
			for(var i in goodsList){
				var goods:ElementGoods = <ElementGoods>this.renderElementInternal(SceneElementType.GOODS,goodsList[i],SceneLayerType.GOODS);

				if(goods){
					this._goodsList.push(goods);
				}
			}

			if(this._goodsList.length > 0){
				this._goodsIndex = 0;
				this.navigateToElement(this._goodsList[this._goodsIndex].data.vo.id);
			}
		}
		//
		public clearGoods():void{
			for(var i in this._goodsList){
				this.removeElement(this._goodsList[i]);
			}
		}

		/**
		 * 移除一个玩家 
		 * @param id
		 * 
		 */		
		public removePlayer(id:string):void{
			this.removeElementById(id);
		}
		//
		/**
		 * 清空场景  
		 * 
		 */		
		public clearScene():void{
			super.clearScene();

			if(this._role)
				(<Role><any> (this._role)).changeScene(this);
		}

		/**
		 * 到达导航点事件处理 
		 * @param event
		 * 
		 */		
		public sceneArriveNiviPoint(event:SceneEvent):void{
			var item:SceneNavigatorDataItem = <SceneNavigatorDataItem><any> (event.data);

			//LogManager.debug(this,"sceneArriveNiviPoint , item = " + item);
			
			if(item){
				//LogManager.debug(this,"sceneArriveNiviPoint ,item.elementId = " + item.elementId);

				//固定场景元素
				if(item.elementId != 0){
					this.removeElementById(item.elementId + "");

					this._goodsIndex ++;
					if(this._goodsList[this._goodsIndex]){
						this.navigateToElement(this._goodsList[this._goodsIndex].data.vo.id);
					}else{
						this._sceneData.addWinCount();
					}
				}else if(item.sceneId > 0){
					//场景坐标
				}
			}
		}
		//
		/**
		 * 获取场景元素速度 
		 * @return 
		 * 
		 */		
		public getElementSpeed():number{
			return this._sceneElementData.getElementSpeed();
		}
		//
		/**
		 * 回收场景元素 
		 * @param element:SceneElement 场景元素
		 * 
		 */		
		public recoverElement(element:SceneElement):void{
			this._sceneElementManager.recoverElement(element);
		}
		//
		/**
		 * 场景元素移动结束 
		 * @param target:SceneElement 场景元素
		 * 
		 */		
		public elementMovingEnd(target:SceneElement):void{
			if(target == this._role){
				/*var entryLo:EntryPointLo = dataManager().sceneData.checkEntryPoint(_role.x,_role.y);
				if(entryLo){
					//改为移动返回后进入传送场景
					//					sendData(ModuleNumber.SCENE,SceneCommand.ENTER_SCENE,{id:entryLo.entryId},entryLo.roleBornPointId);
					//					SceneManager.getInstance().enterScene(entryLo.entryId);
					//					SceneManager.getInstance().gotoRoleBornPoint(entryLo.roleBornPointId);
				}else */
				if(this._currentNaviItem){
					//调度导航事件
					this.checkArriveNaviPoint();
				}
				
//				sendData(ModuleNumber.SCENE,SceneCommand.MOVING,{x:_role.x,y:_role.y},null,false);
			}else{
				var item:SceneElementDataItem = (<SceneElement><any> target).data;
				
				if(!this.isInRenderRect(item.vo.x,item.vo.y)){
					this.removeElementById(item.vo.idString);
				}
			}
		}
		//
		/**
		 * 渲染动态场景元素 
		 * 
		 */		
		public renderDynamicElements(rect:Rectangle):void{
			var vo:SceneElementVo = null;
			var lo:SceneElementLo = null;
			var id:string = null;
			var mover:SceneElementMover = null;
			
			//动态场景元素渲染
			var length:number = this._sceneData.dynamicElementsMap.content.length;
			for(var i:number = 0;i < length;i++){
				var item:SceneElementDataItem = this._sceneData.dynamicElementsMap.content[i];
				vo = item.vo;

				if(rect.contains(vo.x,vo.y)){
					this.renderElementInternal(SceneElementType.PLAYER,item,SceneLayerType.BIOLOGY);
				}else{
					id = vo.idString;
					mover = this._elementsIdMap.get(id);
				}
			}
		}
		//
		/**
		 * 根据数据项目渲染场景元素 
		 * @param item:SceneElementDataItem 场景元素数据项目
		 * 
		 */		
		public renderElement(item:SceneElementDataItem):void{
			if(this._elementsIdMap.containsKey(item.vo.idString)) return;

			var vo:SceneElementVo = item.vo;

			this.renderElementInternal(SceneElementType.PLAYER,item,SceneLayerType.BIOLOGY);
		}
		//
		/**
		 * 渲染怪物
		 * @param item  场景元素数据项目
		 */
		public renderMonster(item:SceneElementDataItem):ElementMonster{
			if(this._elementsIdMap.containsKey(item.vo.idString)) return null;

			var monster:ElementMonster = <ElementMonster>this.renderElementInternal(SceneElementType.MONSTER,item,SceneLayerType.BIOLOGY);

			return monster;
		}
		//
		/**
		 * 渲染场景元素
		 * @param type:int 场景类型 SceneElementType
		 * @param data:SceneElementDataItem 场景元素数据
		 * @return
		 *
		 */
		public renderElementInternal(type:number,data:SceneElementDataItem,layerType:number):SceneElement{
			if(this._elementsIdMap.containsKey(data.id)) return null;

			var element:SceneElement = null;

			switch(type){
				case SceneElementType.MONSTER:
					element = this._sceneElementManager.getElement(ElementMonster);
					break;
				case SceneElementType.GOODS:
					element = this._sceneElementManager.getElement(ElementGoods);
					break;
				case SceneElementType.PLAYER:
					element = this._sceneElementManager.getElement(ElementPlayer);
					break;
			}
			if(element){
				element.setData(data);

				this.addElement(element,layerType);
			}

			return element;
		}
		//
		/**
		 * 主角移动 
		 * 
		 */		
		public roleMoving():void{
			super.roleMoving();
		}
		/**
		 * 玩家主动开始移动 
		 */		
		public startMove():void{
			super.startMove();
			
			//sendData(ModuleNumber.SCENE,SceneCommand.MOVING,{x:this._role.finalX,y:this._role.finalY},null,false);
		}
		//
		/**
		 * 导航至当前场景中的元素，元素可以是非固定场景元素
		 * @param id:Number 元素lo或vo中的id
		 *
		 */
		public navigateToElement(id:number):void{
			if(!this._currentNaviItem){
				this._currentNaviItem = new SceneNavigatorDataItem();
			}
			this._currentNaviItem.elementId = id;

			var element:SceneElement = this.getElement(id + "");
			if(element)
				this.navigateTo(element.x,element.y);
		}
		//
		/**
		 * 导航至当前场景中的坐标
		 * @param x:Number
		 * @param y:Number
		 *
		 */
		public navigateTo(x:number,y:number):void{
			if(this.checkArriveNaviPoint())
				return;

			super.navigateTo(x,y);

			//this.sendData(ModuleNumber.SCENE,SceneCommand.MOVING,{x:x,y:y},null,false);
		}
		//
		/**
		 * 获取场景元素坐标点
		 * @return
		 *
		 */
		public getElementPoint(id:string):Point{
			var element:SceneElement = this.getElement(id);
			if(element)
				return new Point(element.x,element.y);

			return new Point();
		}
	}
}