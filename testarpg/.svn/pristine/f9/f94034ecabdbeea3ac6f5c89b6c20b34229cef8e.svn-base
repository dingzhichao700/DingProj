var egret;
(function (egret) {
    var SceneManager = (function () {
        /**
         * 构造函数
         */
        function SceneManager() {
            /**
             * 当前场景对象
             */
            this.scene = null;
            //场景数据
            this._sceneData = null;
            //导航数组
            this._naviItems = null;
            //当前导航数据
            this._currentItem = null;
            //当前导航数据索引
            this._currentIndex = 0;
            //当前导航是否为上行
            this._isUpper = false;
            this._sceneData = egret.dataManager().sceneData;
        }
        var __egretProto__ = SceneManager.prototype;
        SceneManager.getInstance = function () {
            return SceneManager._instance || (SceneManager._instance = new SceneManager());
        };
        //
        /**
         * 场景导航至舞台坐标点
         * @param point:Point = null 舞台坐标点，参数为 null 时导航至舞台鼠标点
         */
        __egretProto__.navigateToStage = function (point) {
            if (point === void 0) { point = null; }
            if (!point) {
                //mouseX,mouseY，应为玩家点击屏幕或者向前的坐标，因egret没有，先用x,y代替
                point = new egret.Point(egret.ApplicationManager.getInstance().stage.x, egret.ApplicationManager.getInstance().stage.y);
            }
            this.scene.isoMap.mapTileContainer.globalToLocal(point.x, point.y, point);
            this.scene.navigate(-1, -1, point.x, point.y);
        };
        /**
         * 跨场景导航
         * @param sceneId:Number = -1 场景id，指定此参数时，elementId参数无效，可指定x,y
         * @param elementId:Number = -1 目标场景元素id，为场景固定元素id，指定此参数场景id使用-1才有效，已指定此参数时后面的参数无效
         * @param x:Number = -1 目标场景x
         * @param y:Number = -1 目标场景y
         *
         */
        __egretProto__.navigate = function (sceneId, elementId, x, y) {
            if (sceneId === void 0) { sceneId = -1; }
            if (elementId === void 0) { elementId = -1; }
            if (x === void 0) { x = -1; }
            if (y === void 0) { y = -1; }
            //if(this._sceneData.sceneType == SceneType.CITY){
            //	if(sceneId == -1){
            //		if(elementId > -1){
            //			var lo:SceneElementLo = dataManager().sceneData.getFixedElementLoById(elementId);
            //		}
            //		if(!lo){
            //			lo = dataManager().worldMapData.getFixedElementLoById(elementId);
            //		}
            //		if(lo){
            //			sceneId = lo.sceneId;
            //		}else{
            //			sceneId = dataManager().sceneData.cityId;
            //		}
            //	}
            //
            //	this._naviItems = dataManager().worldMapData.searchPath(
            //		dataManager().sceneData.cityId,
            //		sceneId,elementId,x,y);
            //
            //	if(this._naviItems.length > 0){
            //		this._currentIndex = -1;
            //		this._isUpper = dataManager().sceneData.cityId != sceneId && dataManager().sceneData.cityId != SceneId.WORLD_MAP_ID;
            //		this.navigateNext();
            //	}
            //}else{
            //	this.scene.navigate(sceneId,elementId,x,y);
            //}
        };
        //
        /**
         * 跨场景导航
         * @param items:Array 导航项目
         * @param isUpper:Boolean = false 是否需要上行
         */
        __egretProto__.navigateByItems = function (items, isUpper) {
            if (isUpper === void 0) { isUpper = false; }
            this._naviItems = items;
            if (this._naviItems.length > 0) {
                this._currentIndex = -1;
                this._isUpper = isUpper;
                this.navigateNext();
            }
        };
        //
        /**
         * 检测下一个导航数据
         *
         */
        __egretProto__.navigateNext = function () {
            if (!this._naviItems)
                return;
            this._currentIndex++;
            this._currentItem = this._naviItems[this._currentIndex];
            if (this._currentItem) {
                if (this._isUpper) {
                    this._isUpper = false;
                    SceneManager.getInstance().enterScene(egret.SceneType.WORLD_MAP);
                }
                else {
                    SceneManager.getInstance().scene.navigateToItem(this._currentItem);
                }
            }
            else {
                this._naviItems = null;
            }
        };
        //
        /**
         * 清空当前导航数据
         *
         */
        __egretProto__.clearNavigate = function () {
            this._naviItems = null;
        };
        //
        /**
         * 请求成功后进入场景
         * @param id:Number 场景id
         *
         */
        __egretProto__.enterScene = function (type, id) {
            if (id === void 0) { id = -1; }
            if (this._sceneData.sceneType == type && this._sceneData.sceneId == id) {
                throw new Error("重复进入当前场景, type = " + type + ", id = " + id);
            }
            var cls = null;
            var isClear = true;
            var mapId = 0;
            switch (type) {
                case egret.SceneType.CITY:
                    cls = egret.SceneWindow;
                    this._sceneData.cityId = id;
                    var sceneLo = egret.LocalData.getInstance().getSceneLo(id);
                    if (sceneLo)
                        mapId = sceneLo.mapId;
                    break;
            }
            this.exitScene(isClear);
            this._sceneData.sceneType = type;
            this._sceneData.sceneId = id;
            id = mapId > 0 ? mapId : id;
            if (!this.scene)
                this.scene = (egret.openWindow(cls, false));
            this.scene.loadData(id);
        };
        //
        /**
         * 退出场景
         * @param isClear:Boolean = true 是否清理场景数据
         */
        __egretProto__.exitScene = function (isClear) {
            if (isClear === void 0) { isClear = true; }
            this.clearScene(isClear);
            egret.closeWindow(this.scene);
            this.scene = null;
            switch (this._sceneData.sceneType) {
                case egret.SceneType.CITY:
                    break;
            }
        };
        //
        /**
         * 进入世界地图后返回当前城市
         *
         */
        __egretProto__.backToCity = function () {
            this.exitScene();
            this.enterScene(egret.SceneType.CITY, this._sceneData.cityId);
        };
        //
        /**
         * 清空场景
         * @param isClear:Boolean = true 是否清理场景数据
         */
        __egretProto__.clearScene = function (isClear) {
            if (isClear === void 0) { isClear = true; }
            if (this.scene)
                this.scene.clearScene();
            switch (this._sceneData.sceneType) {
                case egret.SceneType.CITY:
                    if (isClear)
                        this._sceneData.clearData();
                    break;
            }
        };
        //
        /**
         * 移动场景元素
         * @param id:String 场景元素id
         * @param x:int 目标x
         * @param y:int 目标y
         *
         */
        __egretProto__.moveElement = function (id, x, y) {
            if (y === void 0) { y = 0; }
            if (!this.scene)
                return;
            this.scene.moveElement(id + "", x, y);
        };
        //
        /**
         * 主角跳转至场景x,y处
         * @param x
         * @param y
         *
         */
        __egretProto__.gotoXY = function (x, y) {
            if (y === void 0) { y = 0; }
            if (!this.scene)
                return;
            this.scene.gotoXY(x, y);
        };
        SceneManager._instance = null;
        return SceneManager;
    })();
    egret.SceneManager = SceneManager;
    SceneManager.prototype.__class__ = "egret.SceneManager";
})(egret || (egret = {}));
//# sourceMappingURL=SceneManager.js.map