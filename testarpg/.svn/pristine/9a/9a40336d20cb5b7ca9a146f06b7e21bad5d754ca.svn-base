module egret{
    /**
     * 法师
     */
    export class PlayerMage extends ElementPlayer{
        public constructor(){
            super();
        }
        //
        /**
         * 获取攻击范围，不同职业和怪物重写
         * @returns {number}
         */
        public getAttackRange():number{
            return 300;
        }
        //
        /**
         * 释放技能
         */
        public playSkill():void {
            if (!this.scene) return;

            //职业及技能类型处理
            var playerVo:ScenePlayerVo = <ScenePlayerVo>this.data.vo;

            if(this._avatar.frameIndex == 5){
                //疾光退
                if(this.getSkillTime(SkillType.MAGE_THUNDER_BACK) > dataManager().fightData.getSkillIntervalTime(SkillType.MAGE_THUNDER_BACK)){
                    this.setUseSkill(SkillType.MAGE_THUNDER_BACK);

                    var skill:ElementSkill = <ElementSkill>SceneElementManager.getInstance().getElement(ElementSkill);
                    skill.setAvatarDirectionSplit(true);
                    skill.setMovieName(SceneElementData.getInstance().getSkillMovieName(playerVo.vocation,3));
                    this.scene.addElement(skill,SceneLayerType.BATTLE_EFFECT,this._attackTarget.vo.x,this._attackTarget.vo.y);

                    var targets:Array<SceneElementDataItem> = this.getDamageTargets(SkillType.MAGE_THUNDER_BACK);
                    var radius:number = 150;
                    
                    for(var i in targets){
                        var element:SceneElementDriver = <SceneElementDriver>this.scene.getElement(targets[i].vo.idString);

                        if(element){
                            if(targets[i] == this._attackTarget){
                                var x:number = this._x;
                                var y:number = this._y;
                            }else{
                                x = this._attackTarget.vo.x;
                                y = this._attackTarget.vo.y;
                            }

                            var distance:number = DimensionUtil.distance2(this._attackTarget.vo.x,this._attackTarget.vo.y,x,y);

                            element.stepBack(x,y,radius + distance);
                        }
                    }

                    this.damage(SkillType.MAGE_THUNDER_BACK,targets);
                }else{
                    var mageSkill:ElementMageNormalSkill = <ElementMageNormalSkill>SceneElementManager.getInstance().getElement(ElementMageNormalSkill);
                    mageSkill.setMovieName(SceneElementData.getInstance().getSkillMovieName(playerVo.vocation,1));
                    this.scene.addElement(mageSkill,SceneLayerType.BATTLE_EFFECT);
                    mageSkill.attackTo(this.x,this.y - 50,this._attackTarget,0,-50,90,this.getAttackRange());

                    this.damage(SkillType.MAGE_NORMAL);
                }
            }else if(this._avatar.frameIndex == this._avatar.frameIndexMax){
                if(this.skillType == SkillType.MAGE_THUNDER_BACK){
                    this.chaseArmies(this.armies);
                }else{
                    this.checkAutoAttack2();
                }
            }
        }
        //
        /**
         * 获取技能伤害敌人数据，不同技能重写，默认为单体伤害敌人数据
         * @param skillType 技能类型
         * @returns {Array<SceneElementDataItem>}
         */
        public getDamageTargets(skillType:number = 0):Array<SceneElementDataItem>{
            this._damageTargets.length = 0;

            switch (skillType){
                case SkillType.MAGE_NORMAL:
                case SkillType.MAGE_THUNDER:
                    this._damageTargets.push(this._attackTarget);
                    break;
                case SkillType.MAGE_THUNDER_BACK:
                    this._damageTargets.push(this._attackTarget);
                    var range:number = this.getAttackRange();

                    for(var i in this.armies){
                        if(this.armies[i] && this._attackTarget != this.armies[i]){
                            var vo:SceneDriverVo = <SceneDriverVo>this.armies[i].vo;
                            if(vo.hp > 0) {
                                var distance:number = DimensionUtil.distance2(this._attackTarget.vo.x,this._attackTarget.vo.y,vo.x, vo.y);

                                if(distance < range){
                                    this._damageTargets.push(this.armies[i]);
                                }
                            }
                        }
                    }
                    break;
            }

            return this._damageTargets;
        }
    }
}