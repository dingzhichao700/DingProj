
module egret {

	export class SceneManager{
		/**
		 * 当前场景对象 
		 */		
		public scene:SceneDriver = null;
		
		private static _instance:SceneManager = null;
		//场景数据
		private _sceneData:SceneData = null;
		
		//导航数组
		private _naviItems:Array<any> = null;
		//当前导航数据
		private _currentItem:SceneNavigatorDataItem = null;
		//当前导航数据索引
		private _currentIndex:number = 0;
		//当前导航是否为上行
		private _isUpper:boolean = false;
		
		/**
		 * 构造函数
		 */
		public constructor(){
			this._sceneData = dataManager().sceneData;
		}
		
		public static getInstance():SceneManager{
			return SceneManager._instance || (SceneManager._instance = new SceneManager());
		}
		//
		/**
		 * 场景导航至舞台坐标点 
		 * @param point:Point = null 舞台坐标点，参数为 null 时导航至舞台鼠标点
		 */		
		public navigateToStage(point:Point = null):void{
			if(!point){
				//mouseX,mouseY，应为玩家点击屏幕或者向前的坐标，因egret没有，先用x,y代替
				point = new Point(ApplicationManager.getInstance().stage.x,ApplicationManager.getInstance().stage.y);
			}
			this.scene.isoMap.mapTileContainer.globalToLocal(point.x,point.y,point);
			this.scene.navigate(-1,-1,point.x,point.y);
		}
		/**
		 * 跨场景导航 
		 * @param sceneId:Number = -1 场景id，指定此参数时，elementId参数无效，可指定x,y
		 * @param elementId:Number = -1 目标场景元素id，为场景固定元素id，指定此参数场景id使用-1才有效，已指定此参数时后面的参数无效
		 * @param x:Number = -1 目标场景x
		 * @param y:Number = -1 目标场景y
		 * 
		 */		
		public navigate(sceneId:number = -1,elementId:number = -1,x:number = -1,y:number = -1):void{
			//if(this._sceneData.sceneType == SceneType.CITY){
			//	if(sceneId == -1){
			//		if(elementId > -1){
			//			var lo:SceneElementLo = dataManager().sceneData.getFixedElementLoById(elementId);
			//		}
			//		if(!lo){
			//			lo = dataManager().worldMapData.getFixedElementLoById(elementId);
			//		}
			//		if(lo){
			//			sceneId = lo.sceneId;
			//		}else{
			//			sceneId = dataManager().sceneData.cityId;
			//		}
			//	}
            //
			//	this._naviItems = dataManager().worldMapData.searchPath(
			//		dataManager().sceneData.cityId,
			//		sceneId,elementId,x,y);
            //
			//	if(this._naviItems.length > 0){
			//		this._currentIndex = -1;
			//		this._isUpper = dataManager().sceneData.cityId != sceneId && dataManager().sceneData.cityId != SceneId.WORLD_MAP_ID;
			//		this.navigateNext();
			//	}
			//}else{
			//	this.scene.navigate(sceneId,elementId,x,y);
			//}
		}
		//
		/**
		 * 跨场景导航  
		 * @param items:Array 导航项目
		 * @param isUpper:Boolean = false 是否需要上行
		 */		
		public navigateByItems(items:Array<any>,isUpper:boolean = false):void{
			this._naviItems = items;
			
			if(this._naviItems.length > 0){
				this._currentIndex = -1;
				this._isUpper = isUpper;
				this.navigateNext();
			}
		}
		//
		/**
		 * 检测下一个导航数据 
		 * 
		 */		
		public navigateNext():void{
			if(!this._naviItems) return;
			
			this._currentIndex ++;
			
			this._currentItem = this._naviItems[this._currentIndex];
			
			if(this._currentItem){
				if(this._isUpper){
					this._isUpper = false;
					SceneManager.getInstance().enterScene(SceneType.WORLD_MAP);
				}else{
					SceneManager.getInstance().scene.navigateToItem(this._currentItem);
				}
			}else{
				this._naviItems = null;
			}
		}
		//
		/**
		 * 清空当前导航数据 
		 * 
		 */		
		public clearNavigate():void{
			this._naviItems = null;
		}
		//
		/**
		 * 请求成功后进入场景 
		 * @param id:Number 场景id
		 * 
		 */		
		public enterScene(type:number,id:number = -1):void{
			if(this._sceneData.sceneType == type && this._sceneData.sceneId == id){
				throw new Error("重复进入当前场景, type = " + type + ", id = " + id);
			}
			
			var cls:any = null;
			var isClear:boolean = true;
			var mapId:number = 0;
			
			switch(type){
				//城市
				case SceneType.CITY:
					cls = SceneWindow;
					
					this._sceneData.cityId = id;
					var sceneLo:SceneLo = LocalData.getInstance().getSceneLo(id);
					if(sceneLo)
						mapId = sceneLo.mapId;
					break;
				//世界地图
				//case SceneType.WORLD_MAP:
				//	cls = WorldMapWindow;
				//
				//	id = SceneId.WORLD_MAP_ID;
				//
				//	this._sceneData.isChanged = true;
				//	this.dataManager().worldMapData.isInWorld = true;
				//
				//	isClear = false;
				//
				//	GameManager.getInstance().closeWindows();
				//	break;
			}
			
			this.exitScene(isClear);
			
			this._sceneData.sceneType = type;
			this._sceneData.sceneId = id;
			
			id = mapId > 0 ? mapId : id;
			
			if(!this.scene)
				this.scene = <SceneDriver><any> (openWindow(cls,false));
			this.scene.loadData(id);
		}
		//
		/**
		 * 退出场景 
		 * @param isClear:Boolean = true 是否清理场景数据
		 */		
		public exitScene(isClear:boolean = true):void{
			this.clearScene(isClear);
			closeWindow(this.scene);
			this.scene = null;
			
			switch(this._sceneData.sceneType){
				//城市
				case SceneType.CITY:
					//this.close(TopWindow);
					//this.close(PlayerHeadWindow);
					break;
				//世界地图
				//case SceneType.WORLD_MAP:
				//	this.close(NavigateWindow);
				//	this.close(GlobalMapWindow);
				//
				//	this.dataManager().worldMapData.isInWorld = false;
				//	break;
			}
		}
		//
		/**
		 * 进入世界地图后返回当前城市
		 * 
		 */		
		public backToCity():void{
			this.exitScene();
			this.enterScene(SceneType.CITY,this._sceneData.cityId);
		}
		//
		/**
		 * 清空场景 
		 * @param isClear:Boolean = true 是否清理场景数据
		 */		
		public clearScene(isClear:boolean = true):void{
			if(this.scene)
				this.scene.clearScene();
			
			switch(this._sceneData.sceneType){
				//城市
				case SceneType.CITY:
					if(isClear)
						this._sceneData.clearData();
					break;
				//世界地图
				//case SceneType.WORLD_MAP:
				//	break;
			}
		}
		//
		/**
		 * 移动场景元素 
		 * @param id:String 场景元素id
		 * @param x:int 目标x
		 * @param y:int 目标y
		 * 
		 */		
		public moveElement(id:number,x:number,y:number = 0):void{
			if(!this.scene) return;
			
			this.scene.moveElement(id + "",x,y);
		}
		//
		/**
		 * 主角跳转至场景x,y处 
		 * @param x
		 * @param y
		 * 
		 */
		public gotoXY(x:number,y:number = 0):void{
			if(!this.scene) return;
			
			this.scene.gotoXY(x,y);
		}
	}
}